<style>
.table1 th:first-child  {
	width: 110px;
}
.table1 th:nth-of-type(2)  {
	width: 50px;
}
.table1 th:nth-of-type(3)  {
	width: 100px;
}
.table1 td {
	vertical-align: top;
}
.table1 {
	font-size: 10px;
}
.quote1 {
	font-size: 12px;
}
</style>

# Mobile Reader #

On loading the app, it will show  first the splash screen for a few seconds then the login screen.


![alt text][mobile1] 

- __logout__ will be disabled in login screen  
- __home__ will be disabled in login screen 
- __settings__ - not disabled. 

To Login, validate first from local. If not found, use the standard LoginService.login (ask Worgie there is already a mobile handler interceptor). After successful login, store the username and password in the mobile device so just in case the logout was clicked and mobile was not connected to the server, they can still validate the login. 

On clicking settings will go to the ff. screen

![alt text][mobile2] 

__Connection__ - store values here for connecting to the local waterworks server - specifically the WaterworksMobileSupportService.

## Update Consumption Rates Rules ##
The Update Rates will display the ff. screen below. Click on ```Get Latest Updates``` to load the formulas. This will call the  __WaterworksMobileSettingService.getConsumptionRateRules__ service. The rulenames will be displayed from highest order to lowest order salience. See wm_rate structure.

![alt text][mobile3] 

The script will be in javascript form and will be generated by the server. The sample rule below:


![alt text][samplerule1] 

will be generated into the ff. script:

```
function COMPUTATION_FOR_SUBDIVISION(facts,result) {
  var WC=facts.WaterConsumption;
  var VOL=facts.WaterConsumption.volume;
  var UNITS=facts.WaterAccount.units;

  if( facts.WaterworksAttribute.name.match('.*SUBDIVISION.*')!=null 
    && facts.WaterAccount.classification.match('.*RESIDENTIAL.*')!=null) {
      var action0 =function() {
        if(  VOL <=  (10 * UNITS) ) {
          return (1.8 * VOL );
        } 
        else if( VOL <= (20* UNITS) ) {
          return (18 * UNITS) + ((VOL - (10*UNITS) ) * 2.3);
        }
        else if( VOL <= (30 * UNITS) ) {
          return ( 41 * UNITS ) + ((VOL - (20*UNITS) ) * 2.8);
        }
        else if( VOL <= (40*UNITS) ) {
          return  ( 69  * UNITS) + ((VOL - (30*UNITS) ) * 3.4);
        }
        else {
          return ( 103 * UNITS) + ((VOL - (40*UNITS) ) * 5);
        }
      };
      WC.amount=action0(); 
      return true; 
    }
    else {
      return false; 
    } 
  }",
```

When processing the script this is the suggested code. Assume the list contains the interpreted code above. Store first the values into the facts, then iterate each rule until it returns true. Fill up the JSON fields provided by the fact (Pls. check I did not test the code)

```
var results = {}
var facts = {};
facts.WaterConsumption = {  amount: ?, volume: ? }
facts.WaterAccount = { classification:?, metersize: ?, units: ? }
facts.WaterworksAttribute = { name: ? } //join the attributes using | for regex match ex. SENIOR|LOT_DONOR

for( var i=0; i< rules.length; i++) {
    var t = rules[i]( facts, results );
    if( t == true ) break;  
}

var rate = facts.WaterConsumption.amount;

```


## Printer Setup ##
Design to follow.

## Home Screen ##
After successful login the home screen will display. This will list the batches downloaded. Click on Add Batch to add a new batch. 

![alt text][mobile4] 

On pressing ```Start Download``` this happens. 

> 1. Pass batchid(batch number) and userid to  __WaterworksMobileSupportService.getBatch__ method. This will return the __wm_batch__ and list of associated __wm_stubout__ records. Use the recordcount for your progress bar. Save the batch then save the stubouts. See wm_batch structure.


> 2. Loop through each item maybe by pages of 10 or 20 records by calling __WaterworksMobileSupportService.getBatchAccounts__ method. If there is an error it will return the object below. For the structure of the account see __wm_account__.

```
	[ status: 'ERR', message: <errorMessage> ]
```

Display error. If no error, show record progress. If successful download display the successful screen.
![alt text][mobile5] 

After successful download the screen should display the batch. Ideally the ```Upload``` button should only appear if one or more records have been read.

![alt text][mobile6]


### Viewing the List of Accounts ###
On clicking the batch the list of accounts will be displayed.

![alt text][mobile7]

#### Geo Tag ####
The main purpose is to tag the account or stubout on the lng,lat coordinates. This is initiated by clicking the geotag button. The screen will display. After clicking display, update the lng, lat of the stubout or the account depending on where you clicked. 

```
Geotag for accounts refer to the location of household or meter while stubout is for the cluster of meters.  Not all meters have stubouts
```

![alt text][mobile8]



#### Dropdown Menu ####
Dropdown menu displays filtering options and other batch actions.

![alt text][mobile9]

- __All__ - displays all accounts, no filter.
- __By Stubout__ - displays all accounts by stubouts.
- __Nearest to me__ - displays all accounts by stubouts based on the geo coordinates. It will order the display based on the proximity (radius) relative to the reader.
- __Unread__ - displays only accounts that do not have a reading yet
- __Completed__ - displays only accounts that have completed reading
- __Unmapped__ - shows accounts that do not have mappings
- __Reload List__ - On clicking this will reload the current status of the server. applicable only within the office. Call WaterworksMobileSupportService.getBatch again and compare the data. Logic should be handled by mobile app. You can opt not to implement this for the meantime.
- __Upload Readings__ - clicked when you want to upload all the records that are already read.  Once uploaded, you must delete the record and update the count by calling the server getBatchStatus.

#### Viewing Stubouts ####
Clicked from the dropdown menu - By Stubouts. Displays a list of stubouts from the batch. Clicking on the geotag button will show the geotag screen just like the account geotag. After selecting a stubout it will go back to the accounts list and filter it by stubout.

![alt text][mobile10]

#### Viewing an Account ####
View by clicking or swiping account from the accounts list. It will display the ff. information
![alt text][mobile11]

Click on ```Read``` button to do the reading and displays the ff. screen. The number of digits depends on the capacity - 1. For example meter capacity is 10000, then number of digits is 4 because 10000 - 1 = 9999. There are 4 9's.

![alt text][mobile12]

To calculate for volume, do the ff.


<div class="quote1">

```
volume =  (reading < prevreading) ? reading + metercapacity - prevreading : reading - prevreading
```

</div>


To calculate for amount, run your rates engine. This is just an example. Loop until there is a rule that matches. For example we have a code like this, where the rates engine contains the formulas and account is the data to be evaluated.
```
   RatesEngine r = new RatesEngine();
   r.execute( account );

   class RatesEngine {
        List<RateRule> rates;  //set from rates
        void execute( Account acct ) {
        	for( RateRule r: rates ) {
        		if( r.evalCondition( acct ) == true ) {
        			r.doAction( acct );
        			break;
        		}	
        	}
        }
        //amount will be set in acct.
   } 	

```



After reading it will display the ff. screen. Click Edit to go back to reading and click Submit to finalize the read. After submit is clicked update the __readingdate__ of wm_account. After ```Print Bill``` clicked, update billprintdate.

![alt text][mobile13]

It will change the status of the account from 0 to 1. 
- 0 = for reading 
- 1 = finished reading   
- 2 = bill printed. They should not print the bill if theres nobody to give it to. 

## Uploading Readings ##
Only accounts where state > 0 will be uploaded, i.e. upload even if it was not printed. The most important thing is it is read. After uploading, delete the account and call __WaterworksMobileSupportService.getBatchStatus__ to get latest batch info. If there are no more to upload, delete the batch.


# System Design #

__WaterworksMobileSupportService__
*Note: params are all maps* 

<div class="table1">

| method name | param fields  | return         | description | 
|:---         |:---    		  |:----           |:----        |
|getRates     |none 		  |rateslist: list of wm_rate | called during Update Rates get latest update |
|getBatch     |batchid,userid |wm_batch,wm_stubout| called during add Batch in mobile. handle exception if any display error message. Save the batch then stubouts |
|getBatchAccounts|batchid, start,limit| list of wm_account               | should be called several times in a looping manner. The mobile app will manage what records to fetch |   
|getBatchStatus|batchid| wm_batch| returns the current status including recordcount |   
|uploadReadings|wm_account| status OK |uploads records to the server. Mobile app should be the one to manage to delete the record once uploaded and delete the batchwhen all accounts are uploaded |   

</div>

## Schema ##
![alt text][schema] 

*if field type not specified assume as string*

[mobile1]: ./images/mobile1.png
[mobile2]: ./images/mobile2.png
[mobile3]: ./images/mobile3.png
[mobile4]: ./images/mobile4.png
[mobile5]: ./images/mobile5.png
[mobile6]: ./images/mobile6.png
[mobile7]: ./images/mobile7.png
[mobile8]: ./images/mobile8.png
[mobile9]: ./images/mobile9.png
[mobile10]: ./images/mobile10.png
[mobile11]: ./images/mobile11.png
[mobile12]: ./images/mobile12.png
[mobile13]: ./images/mobile13.png
[samplerule1]: ./images/samplerule1.png

[schema]: ./images/schema.png
