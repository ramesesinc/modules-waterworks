//

@DataContext("waterworks_bill")
def billEm;

@DataContext("waterworks_billitem")
def billItemEm;

@DataContext("waterworks_account_attribute")
def attributeEm;


@ProxyMethod
public def execute(def o ) {

	def bill = billEm.find( [objid: o.objid] ).first();
	
	def facts = [];

	def sel = "objid,item.*,amount:{amount-amtpaid-discount},state:{1}"
	def ym = (bill.year*12)+bill.month;
	def previtems = billItemEm.find( [acctid: bill.acctid]).select(sel).where( "((year*12)+month) < :yrmon AND (amount-amtpaid-discount>0)", [yrmon: ym] ).list();

	def billitems = billItemEm.find( [billid: bill.objid]).select(sel).list();
	(previtems + billitems).each {
		facts << new WaterBillItem(it);
	}

	facts << new WaterBill( bill );

	attributeEm.find([acctid: bill.acctid]).list().each {
		facts << new WaterworksAttribute( name: it.name );
	}

	ruleSvc.execute("waterworksbilling", facts);

	def items = facts.findAll{ it instanceof WaterBillItem && it.state == 0 };
	items.each {
		//insert into waterworks_billitem
		def m = [:];
		m.billid = bill.objid;
		m.itemid = it.itemid;
		m.amount = it.amount;
		m.amtpaid = 0;
		m.discount = 0;
		billItemEm.create( m );
	}

}

